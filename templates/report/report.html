<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PWHL Report</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <style>
    :root {
      --bg:#160A3A; --bg2:#251055; --bg3:#3B1E7A; --surface:rgba(25,16,60,.85); --border:rgba(142,124,214,.25); --accent:#8E7CD6; --accent-strong:#B9A7FF;
      --font-stack:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,Helvetica,Arial,sans-serif;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:var(--font-stack); background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 48%,var(--bg3) 100%); color:#fff; }
    header { display:flex; align-items:center; justify-content:space-between; padding:.9rem 1.4rem; background:var(--surface); border-bottom:1px solid var(--border); }
    h1 { font-size:1.1rem; margin:0; letter-spacing:.5px; font-weight:600; }
    nav a { color:#fff; text-decoration:none; margin-right:1rem; font-size:.85rem; opacity:.8; }
    nav a.active, nav a:hover { opacity:1; }
    .layout { display:grid; grid-template-columns:280px 1fr; min-height:calc(100vh - 64px); }
    aside { padding:1rem 1.25rem; background:var(--surface); border-right:1px solid var(--border); overflow-y:auto; }
    main { padding:1rem 1.25rem 2rem; }
    .section-label { font-size:.7rem; font-weight:600; letter-spacing:.6px; text-transform:uppercase; opacity:.65; margin:.85rem 0 .4rem; }
    select, button, input { font-family:inherit; font-size:.8rem; }
    select, input { width:100%; background:#1f1547; color:#fff; border:1px solid var(--border); border-radius:4px; padding:.35rem .5rem; }
    button { background:var(--accent); border:none; color:#fff; padding:.5rem .85rem; border-radius:4px; cursor:pointer; font-weight:600; }
    button:hover { background:var(--accent-strong); }
    .filters-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:.6rem; }
    .kpis { display:flex; flex-wrap:wrap; gap:.75rem; margin:.75rem 0 1rem; }
    .kpi { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:.65rem .8rem; min-width:110px; }
    .kpi .v { font-size:1.05rem; font-weight:600; }
    .kpi .l { font-size:.65rem; text-transform:uppercase; letter-spacing:.5px; opacity:.75; }
    table { width:100%; border-collapse:collapse; font-size:.72rem; }
    thead th { position:sticky; top:0; background:#241253; z-index:2; padding:.45rem .4rem; text-align:left; font-weight:600; letter-spacing:.5px; font-size:.65rem; }
    tbody td { padding:.4rem .45rem; border-top:1px solid #2d1f64; }
    tbody tr:nth-child(2n) { background:#1d1144; }
    tbody tr:hover { background:#2a1961; }
    .table-wrap { max-height:60vh; overflow:auto; border:1px solid var(--border); border-radius:6px; background:var(--surface); }
    .pill { display:inline-block; padding:.15rem .4rem; border-radius:12px; font-size:.6rem; font-weight:600; letter-spacing:.5px; background:#2d1f64; }
    footer { text-align:center; font-size:.6rem; opacity:.5; margin-top:2rem; }
    .loader { padding:1.25rem; text-align:center; font-size:.75rem; opacity:.8; }
    .actions-row { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.75rem; }
  </style>
</head>
<body>
  <header>
    <h1>PWHL Report</h1>
    <nav>
      <a href="/" >Home</a>
      <a href="/report" class="active">Report</a>
    </nav>
  </header>
  <div class="layout">
    <aside>
      <div class="section-label">Data Source</div>
      <div style="font-size:.65rem; line-height:1.1rem; opacity:.8;">Reads pre-generated CSVs from <code>Data/Play-by-Play</code> & <code>Data/Lineups</code>. No live API calls.</div>
      <div class="section-label">Filters</div>
      <div class="filters-grid" id="filters">
        <div><select id="fltTeam"><option value="">Team</option></select></div>
        <div><select id="fltEvent"><option value="">Event</option></select></div>
        <div><select id="fltPlayer"><option value="">Player</option></select></div>
        <div><select id="fltGoalie"><option value="">Goalie</option></select></div>
        <div><select id="fltPeriod"><option value="">Period</option></select></div>
        <div><select id="fltStrength"><option value="">Strength</option></select></div>
        <div><select id="fltVenue"><option value="">Venue</option></select></div>
      </div>
      <div class="actions-row">
        <button id="btnApply">Apply</button>
        <button id="btnReset" style="background:#374151;">Reset</button>
        <button id="btnExport">Export CSV</button>
      </div>
      <div class="section-label">Status</div>
      <div style="font-size:.65rem; opacity:.7;" id="loadStatus">Idle</div>
    </aside>
    <main>
      <section>
        <div class="kpis" id="kpis"></div>
        <div class="table-wrap" id="tableWrap"><div class="loader">Loading files...</div></div>
      </section>
    </main>
  </div>
  <footer>
    Built from static CSV exports. Updated on load.
  </footer>
<script>
(async function(){
  const state = { raw: [], filtered: [], meta: {teams:new Set(), events:new Set(), players:new Set(), goalies:new Set(), periods:new Set(), strengths:new Set(), venues:new Set()} };
  const el = id => document.getElementById(id);
  // Use backend /data route to serve CSV safely (read-only)
  const CSV_DIR = '/data/Play-by-Play/';
  const LINEUPS_DIR = '/data/Lineups/';

  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(!lines.length) return [];
    const cols = lines[0].split(',');
    return lines.slice(1).map(line=>{
      const cells = [];
      let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const c=line[i]; if(c==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } } else if(c===',' && !inQ){ cells.push(cur); cur=''; } else { cur+=c; } } cells.push(cur);
      const obj={}; cols.forEach((h,idx)=>obj[h]=cells[idx]??''); return obj; });
  }

  async function listLocalCSVs(){
    // We cannot list directory contents directly; instead derive from an index manifest if provided
    // Fallback: attempt numeric ids 1..400 and verify existence via HEAD fetch
    const existing=[]; const maxId=400; const probe=[];
    for(let i=1;i<=maxId;i++){ probe.push(i); }
    // Probe sequentially but stop after long gaps to speed up
    let consecutiveMiss=0; for(const id of probe){ const url = `${CSV_DIR}${id}_shots.csv`; try { const r = await fetch(url,{method:'HEAD'}); if(r.ok){ existing.push({id, url}); consecutiveMiss=0; } else { consecutiveMiss++; if(consecutiveMiss>50 && id>50) break; } } catch(e){ consecutiveMiss++; if(consecutiveMiss>50 && id>50) break; } }
    return existing;
  }

  function addMeta(e){
    if(!e.team) return; state.meta.teams.add(e.team); if(e.event) state.meta.events.add(e.event); if(e.p1_name) state.meta.players.add(e.p1_name); if(e.goalie_name) state.meta.goalies.add(e.goalie_name); if(e.period) state.meta.periods.add(e.period); if(e.strength) state.meta.strengths.add(e.strength); if(e.venue) state.meta.venues.add(e.venue);
  }

  function computeKpis(rows){
    const shots = rows.filter(r=>r.event==='Shot' || r.event==='Goal');
    const goals = rows.filter(r=>r.event==='Goal');
    const blocks = rows.filter(r=>r.event==='Block');
    const corsi = shots.length + blocks.length;
    const fenwick = shots.length; // already excludes blocks
    const shPct = shots.length ? (goals.length / shots.length * 100).toFixed(1) : '0.0';
    return [
      {label:'Events', value: rows.length},
      {label:'Shots', value: shots.length},
      {label:'Goals', value: goals.length},
      {label:'Blocks', value: blocks.length},
      {label:'Corsi', value: corsi},
      {label:'Fenwick', value: fenwick},
      {label:'Sh%', value: shPct + '%'}
    ];
  }

  function renderKpis(){
    const k = el('kpis'); const kpis = computeKpis(state.filtered); k.innerHTML = kpis.map(k=>`<div class="kpi"><div class="v">${k.value}</div><div class="l">${k.label}</div></div>`).join('');
  }

  function applyFilters(){
    const fTeam = el('fltTeam').value; const fEvent = el('fltEvent').value; const fPlayer = el('fltPlayer').value; const fGoalie=el('fltGoalie').value; const fPeriod=el('fltPeriod').value; const fStrength=el('fltStrength').value; const fVenue=el('fltVenue').value;
    state.filtered = state.raw.filter(r=>
      (!fTeam || r.team===fTeam) && (!fEvent || r.event===fEvent) && (!fPlayer || r.p1_name===fPlayer) && (!fGoalie || r.goalie_name===fGoalie) && (!fPeriod || r.period===fPeriod) && (!fStrength || r.strength===fStrength) && (!fVenue || r.venue===fVenue)
    );
    renderKpis();
    renderTable();
  }

  function renderTable(){
    const wrap = el('tableWrap'); if(!state.filtered.length){ wrap.innerHTML='<div class="loader">No events match filters.</div>'; return; }
    const header = ['Game','Time','Period','Event','Team','Venue','Strength','Player','Goalie','X','Y'];
    const rows = state.filtered.map(r=>`<tr><td>${r.game_id}</td><td>${r.timestamp}</td><td>${r.period}</td><td>${r.event}</td><td>${r.team}</td><td>${r.venue}</td><td>${r.strength}</td><td>${r.p1_name}</td><td>${r.goalie_name}</td><td>${r.x}</td><td>${r.y}</td></tr>`).join('');
    wrap.innerHTML = `<table><thead><tr>${header.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table>`;
  }

  function populateFilterSelect(sel, values){
    const cur = sel.value; sel.innerHTML = `<option value="">${sel.options[0]?.text||'All'}</option>` + Array.from(values).sort().map(v=>`<option value="${v}">${v}</option>`).join(''); if(values.has(cur)) sel.value=cur;
  }

  function refreshFilterUI(){
    populateFilterSelect(el('fltTeam'), state.meta.teams);
    populateFilterSelect(el('fltEvent'), state.meta.events);
    populateFilterSelect(el('fltPlayer'), state.meta.players);
    populateFilterSelect(el('fltGoalie'), state.meta.goalies);
    populateFilterSelect(el('fltPeriod'), state.meta.periods);
    populateFilterSelect(el('fltStrength'), state.meta.strengths);
    populateFilterSelect(el('fltVenue'), state.meta.venues);
  }

  function resetFilters(){ ['Team','Event','Player','Goalie','Period','Strength','Venue'].forEach(k=> el('flt'+k).value=''); applyFilters(); }

  function exportCSV(){
    if(!state.filtered.length){ alert('Nothing to export'); return; }
    const cols = ['game_id','timestamp','period','event','team','venue','strength','p1_name','goalie_name','x','y'];
    const header = cols.join(',');
    const lines = state.filtered.map(r=>cols.map(c=>`"${String(r[c]||'').replace(/"/g,'""')}"`).join(','));
    const csv = [header, ...lines].join('\n');
    const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pwhl_report_filtered.csv'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 0);
  }

  el('btnApply').addEventListener('click', applyFilters);
  el('btnReset').addEventListener('click', resetFilters);
  el('btnExport').addEventListener('click', exportCSV);

  // Load all CSVs (basic heuristic scanning); if directory listing not allowed, user may provide manifest later.
  el('loadStatus').textContent='Scanning CSV directory...';
  const files = await listLocalCSVs();
  el('loadStatus').textContent=`Discovered ${files.length} game files. Loading...`;

  for(const f of files){
    try {
      const resp = await fetch(f.url, {cache:'no-store'}); if(!resp.ok) continue; const text = await resp.text(); const rows = parseCSV(text); rows.forEach(r=>{ r.game_id = r.game_id || String(f.id); addMeta(r); state.raw.push(r); });
    } catch(e){ console.warn('Load failed', f.url, e); }
  }
  state.filtered = state.raw.slice();
  refreshFilterUI();
  applyFilters();
  el('loadStatus').textContent=`Loaded ${state.raw.length} events across ${files.length} games.`;
})();
</script>
</body>
</html>
