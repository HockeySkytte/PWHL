<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWHL Analytics</title>
    <!-- Favicons: prefer small PNG; fallback to ICO -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png?v=2">
    <link rel="icon" href="/favicon.ico?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='PWHL_logo.png', v='2') }}">
    <meta name="theme-color" content="#160A3A">
    <meta name="screen-orientation" content="landscape">
    <meta name="x5-orientation" content="landscape">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="360-fullscreen" content="true">
    <!-- Social preview image -->
    <meta property="og:image" content="https://pwhl.onrender.com/static/Thumbnail.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://pwhl.onrender.com/static/Thumbnail.png">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LQY14MGCDV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LQY14MGCDV');
    </script>
    
    <style>
        :root {
            --pwhl-bg-1: #160A3A; /* deep purple */
            --pwhl-bg-2: #251055; /* mid purple */
            --pwhl-bg-3: #3B1E7A; /* bright purple */
            --pwhl-surface: rgba(19, 13, 46, 0.75);
            --pwhl-surface-strong: rgba(25, 16, 60, 0.85);
            --pwhl-border: rgba(142, 124, 214, 0.25);
            --pwhl-accent: #8E7CD6; /* light lavender accent */
            --pwhl-accent-strong: #B9A7FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--pwhl-bg-1) 0%, var(--pwhl-bg-2) 48%, var(--pwhl-bg-3) 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .header {
            background: var(--pwhl-surface-strong);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--pwhl-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            background-color: var(--pwhl-accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: var(--pwhl-accent-strong);
        }

        .btn-secondary {
            background-color: #718096;
        }

        .btn-secondary:hover {
            background-color: #4a5568;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin: 0 0.125rem;
            border-radius: 0.25rem;
        }

        .text-muted {
            color: #718096;
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 300px;
            background: var(--pwhl-surface);
            border-right: 1px solid var(--pwhl-border);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            background: transparent;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            background: var(--pwhl-surface-strong);
            border-bottom: 1px solid var(--pwhl-border);
        }

        .tab {background:transparent;color:#d6d3e9;border:none;padding:1rem 2rem;cursor:pointer;border-bottom:3px solid transparent;transition:.2s;font-size:1.05rem;text-decoration:none;display:flex;align-items:center;gap:.4rem;font-weight:600;}
        .tab:hover{color:#fff;text-decoration:none;}
        .tab.active{color:var(--pwhl-accent-strong);border-bottom-color:var(--pwhl-accent-strong);text-decoration:none;}

        .tab-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .logo-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--pwhl-border);
            text-align: center;
        }

        .logo-link {
            display: inline-block;
            transition: opacity 0.2s;
        }

        .logo-link:hover {
            opacity: 0.8;
        }

        .logo-link img {
            width: 120px;
            height: auto;
            border-radius: 8px;
        }

        .logo-attribution {
            margin-top: 0.75rem;
            font-size: 0.9rem;
            font-style: italic;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 0.05em;
        }

        .filter-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .filter-select {
            width: 100%;
            background-color: #4a5568;
            border: 1px solid #718096;
            border-radius: 0.375rem;
            padding: 0.5rem;
            color: #ffffff;
            font-size: 0.875rem;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        /* Date input styling */
        input[type="date"].filter-select {
            color-scheme: dark;
        }

        input[type="date"].filter-select::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4299e1;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: #a0aec0;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .table-container {
            background: var(--pwhl-surface);
            border: 1px solid var(--pwhl-border);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #4a5568;
        }

        .table th:first-child,
        .table td:first-child {
            text-align: left;
        }

        .table th {
            background: rgba(26, 32, 44, 0.5);
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .table tbody tr:hover {
            background-color: rgba(142, 124, 214, 0.12);
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-final {
            background-color: #48bb78;
            color: #1a202c;
        }

        .status-pending {
            background-color: #ed8936;
            color: #1a202c;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #a0aec0;
        }

        .no-data {
            text-align: center;
            color: #a0aec0;
            padding: 2rem;
        }

        .score {
            font-weight: 600;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: #2d3748;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background-color: #1e2329;
            padding: 1rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #4299e1;
        }

        .close {
            color: #a0aec0;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #ffffff;
        }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .game-summary {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .section {
            background-color: #1e2329;
            border: 1px solid #4a5568;
            border-radius: 0.375rem;
            padding: 1rem;
        }

        .section h3 {
            margin: 0 0 1rem 0;
            color: #4299e1;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 0.5rem;
        }

        .section h4 {
            margin: 1rem 0 0.5rem 0;
            color: #e2e8f0;
        }

        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .player-card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.25rem;
            padding: 0.5rem;
        }

        .play-by-play {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .events-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            border-radius: 0.375rem;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid #4a5568;
            background-color: #1e2329;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-item.goal {
            background-color: rgba(72, 187, 120, 0.1);
            border-left: 4px solid #48bb78;
        }

        .event-item.penalty {
            background-color: rgba(245, 101, 101, 0.1);
            border-left: 4px solid #f56565;
        }

        .event-time {
            min-width: 80px;
            text-align: center;
            font-family: 'Courier New', monospace;
            color: #a0aec0;
        }

        .event-description {
            flex: 1;
            color: #e2e8f0;
        }

        /* Clickable row styles */
        .game-row.clickable:hover {
            background-color: #2d3748;
            transition: background-color 0.2s;
        }

        .game-row.clickable:hover td {
            color: #ffffff;
        }
    </style>
    <script>
        function checkOrientation(){
            const warnId='rotateWarning';
            let el=document.getElementById(warnId);
            const isSmall= window.innerWidth < 900 && window.innerHeight > window.innerWidth + 40;
            if(isSmall){
                if(!el){
                    el=document.createElement('div');
                    el.id=warnId;
                    el.style.cssText='position:fixed;inset:auto 0 0 0;background:#0d1120;color:#fff;padding:.6rem .9rem;font-size:.7rem;letter-spacing:.05em;text-align:center;z-index:400;border-top:1px solid rgba(255,255,255,.15);';
                    el.innerHTML='Best viewed in landscape ‚Äì rotate your device for full schedule & rink view.';
                    document.body.appendChild(el);
                }
            } else if(el){ el.remove(); }
        }
        window.addEventListener('load',checkOrientation);
        window.addEventListener('resize',checkOrientation);
        window.addEventListener('orientationchange',()=>setTimeout(checkOrientation,200));
    </script>
</head>
<body>
    <div class="header">
        <h1>
            <img src="{{ url_for('static', filename='PWHL_logo.png') }}" alt="PWHL" style="height:28px; width:auto; vertical-align:middle; display:inline-block;">
            <span>PWHL Analytics</span>
        </h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            <button class="btn" onclick="refreshData()">Refresh</button>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="filter-group">
                <label class="filter-label">Season</label>
                <select class="filter-select" id="seasonFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Seasons</option>
                    <option value="2025/2026" selected>2025/2026</option>
                    <option value="2024/2025">2024/2025</option>
                    <option value="2023/2024">2023/2024</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Season State</label>
                <select class="filter-select" id="seasonStateFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Season States</option>
                    <option value="Regular Season" selected>Regular Season</option>
                    <option value="Playoffs">Playoffs</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Date From</label>
                <input type="date" class="filter-select" id="dateFromFilter" onchange="applyFilters({preferCache: true})">
            </div>

            <div class="filter-group">
                <label class="filter-label">Date To</label>
                <input type="date" class="filter-select" id="dateToFilter" onchange="applyFilters({preferCache: true})">
            </div>

            <div class="filter-group">
                <label class="filter-label">Team</label>
                <select class="filter-select" id="teamFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Teams</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="filter-select" id="statusFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Statuses</option>
                </select>
            </div>

            <div class="logo-section">
                <a href="https://hockey-statistics.com/" target="_blank" rel="noopener noreferrer" class="logo-link">
                    <img src="{{ url_for('static', filename='Logo.png') }}" alt="Hockey Statistics Logo">
                </a>
                <div class="logo-attribution">App by HockeySkytte</div>
            </div>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('schedule')">üìÖ Schedule</button>
                <a class="tab" href="/report">üìä Report</a>
                <a class="tab" href="/data">üóÇÔ∏è Data</a>
            </div>

            <div class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalGames">-</div>
                        <div class="stat-label">Total Games</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedGames">-</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingGames">-</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgGoals">-</div>
                        <div class="stat-label">Avg Goals/Game</div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Season</th>
                                <th>State</th>
                                <th>Away Team</th>
                                <th>Home Team</th>
                                <th>Status</th>
                                <th>Away Score</th>
                                <th>Home Score</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <tr>
                                <td colspan="8" class="loading">Loading schedule data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Game Details -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Game Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let allFilters = {};

        // Simple in-memory cache for schedule responses, keyed by request URL
        const scheduleCache = {};
        const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

        // Helpers: filter state persistence
        function getFilterStateFromUI() {
            return {
                seasonYear: document.getElementById('seasonFilter').value,
                seasonState: document.getElementById('seasonStateFilter').value,
                team: document.getElementById('teamFilter').value,
                status: document.getElementById('statusFilter').value,
                dateFrom: document.getElementById('dateFromFilter').value,
                dateTo: document.getElementById('dateToFilter').value,
            };
        }

        function saveFilterState(state) {
            try {
                localStorage.setItem('pwhl_filters', JSON.stringify(state));
            } catch (e) {
                console.warn('Unable to save filters to localStorage:', e);
            }
        }

        function loadFilterState() {
            try {
                const raw = localStorage.getItem('pwhl_filters');
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.warn('Unable to load filters from localStorage:', e);
                return null;
            }
        }

        function restoreFiltersToUI(state) {
            if (!state) return;
            const seasonEl = document.getElementById('seasonFilter');
            const seasonStateEl = document.getElementById('seasonStateFilter');
            const teamEl = document.getElementById('teamFilter');
            const statusEl = document.getElementById('statusFilter');
            const dateFromEl = document.getElementById('dateFromFilter');
            const dateToEl = document.getElementById('dateToFilter');

            if (state.seasonYear) seasonEl.value = state.seasonYear;
            if (state.seasonState) seasonStateEl.value = state.seasonState;
            if (state.dateFrom) dateFromEl.value = state.dateFrom;
            if (state.dateTo) dateToEl.value = state.dateTo;
            // Team and status options are populated after fetching; set now if "All" or leave for later
            if (state.team && state.team !== 'All') teamEl.value = state.team;
            if (state.status && state.status !== 'All') statusEl.value = state.status;
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Restore any saved filters, then apply
            const saved = loadFilterState();
            if (saved) {
                restoreFiltersToUI(saved);
            }
            applyFilters({ preferCache: true });
        });

        async function loadSchedule() {
            // This function is now handled by applyFilters()
            applyFilters();
        }

        function updateFilterOptions() {
            // Update team filter
            const teamSelect = document.getElementById('teamFilter');
            const currentTeam = teamSelect.value;
            teamSelect.innerHTML = '<option value="All">All Teams</option>';
            allFilters.teams.forEach(team => {
                if (team) {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    if (team === currentTeam) option.selected = true;
                    teamSelect.appendChild(option);
                }
            });

            // Update status filter
            const statusSelect = document.getElementById('statusFilter');
            const currentStatus = statusSelect.value;
            statusSelect.innerHTML = '<option value="All">All Statuses</option>';
            allFilters.statuses.forEach(status => {
                if (status) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    statusSelect.appendChild(option);
                }
            });
        }

        async function applyFilters(options = {}) {
            const { preferCache = false, force = false } = options;
            const seasonYear = document.getElementById('seasonFilter').value;
            const seasonState = document.getElementById('seasonStateFilter').value;
            const team = document.getElementById('teamFilter').value;
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            // Persist current filters
            saveFilterState({ seasonYear, seasonState, team, status, dateFrom, dateTo });

            // Build request URL (also used as cache key)
            let url = `/api/schedule?season_year=${encodeURIComponent(seasonYear)}&season_state=${encodeURIComponent(seasonState)}&team=${encodeURIComponent(team)}&status=${encodeURIComponent(status)}`;
            if (dateFrom) url += `&date_from=${encodeURIComponent(dateFrom)}`;
            if (dateTo) url += `&date_to=${encodeURIComponent(dateTo)}`;

            const now = Date.now();

            // Cache-first path
            const cached = scheduleCache[url];
            const fresh = cached && (now - cached.fetchedAt) < CACHE_TTL_MS;

            if (!force && preferCache && cached) {
                // Render immediately from cache
                const data = cached.data;
                currentData = data.games;
                allFilters = data.filters;
                updateFilterOptions();
                updateStats(data.stats);
                renderTable(data.games);

                // If cache is fresh, skip network; else revalidate in background
                if (fresh) return;

                // Background revalidation
                try {
                    const resp = await fetch(url, { cache: 'no-store' });
                    const newData = await resp.json();
                    scheduleCache[url] = { data: newData, fetchedAt: Date.now() };
                    currentData = newData.games;
                    allFilters = newData.filters;
                    updateFilterOptions();
                    updateStats(newData.stats);
                    renderTable(newData.games);
                } catch (e) {
                    console.warn('Revalidation failed, using cached data:', e);
                }
                return;
            }

            // If we get here and either no cache or not preferring cache, show loading
            document.getElementById('scheduleTableBody').innerHTML = 
                '<tr><td colspan="8" class="loading">Loading schedule data...</td></tr>';

            try {
                const response = await fetch(url, { cache: force ? 'reload' : 'default' });
                const data = await response.json();
                scheduleCache[url] = { data, fetchedAt: Date.now() };

                currentData = data.games;
                allFilters = data.filters;
                updateFilterOptions();
                updateStats(data.stats);
                renderTable(data.games);
            } catch (error) {
                console.error('Error applying filters:', error);
                document.getElementById('scheduleTableBody').innerHTML = 
                    '<tr><td colspan="8" class="no-data">Error loading schedule data</td></tr>';
            }
        }

        function updateStats(stats) {
            document.getElementById('totalGames').textContent = stats.total_games;
            document.getElementById('completedGames').textContent = stats.completed_games;
            document.getElementById('pendingGames').textContent = stats.pending_games;
            
            // Calculate average goals per game
            const completedGames = currentData.filter(game => game.status.includes('Final'));
            if (completedGames.length > 0) {
                const totalGoals = completedGames.reduce((sum, game) => {
                    const home = parseInt(game.home_score) || 0;
                    const away = parseInt(game.away_score) || 0;
                    return sum + home + away;
                }, 0);
                const avgGoals = (totalGoals / completedGames.length).toFixed(1);
                document.getElementById('avgGoals').textContent = avgGoals;
            } else {
                document.getElementById('avgGoals').textContent = '-';
            }
        }

        function renderTable(games) {
            const tbody = document.getElementById('scheduleTableBody');
            
            if (games.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No games found for the selected filters</td></tr>';
                return;
            }

            tbody.innerHTML = games.map(game => {
                const statusClass = game.status.includes('Final') ? 'status-final' : 'status-pending';
                const awayScore = game.away_score || '';
                const homeScore = game.home_score || '';
                
                // Format team logos (just logo, no text as requested)
                const awayTeamDisplay = game.away_team_logo ? 
                    `<div style="display: flex; align-items: center; justify-content: center;"><img src="${game.away_team_logo}" alt="${game.away_team}" style="width: 32px; height: 32px;" title="${game.away_team}"></div>` : 
                    game.away_team;
                const homeTeamDisplay = game.home_team_logo ? 
                    `<div style="display: flex; align-items: center; justify-content: center;"><img src="${game.home_team_logo}" alt="${game.home_team}" style="width: 32px; height: 32px;" title="${game.home_team}"></div>` : 
                    game.home_team;
                
                // Make any game with a valid game_id clickable (including live / in-progress / upcoming)
                const isClickable = !!game.game_id; // allow navigation even before Final for live tracking
                return `
                    <tr class="game-row ${isClickable ? 'clickable' : ''}" onclick="${isClickable ? `goToGamePage('${game.game_id}')` : ''}" style="${isClickable ? 'cursor: pointer;' : 'cursor: default;'}">
                        <td>${game.date}</td>
                        <td>${game.season_year}</td>
                        <td>${game.season_state}</td>
                        <td>${awayTeamDisplay}</td>
                        <td>${homeTeamDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${game.status}</span></td>
                        <td class="score">${awayScore}</td>
                        <td class="score">${homeScore}</td>
                    </tr>
                `;
            }).join('');
        }

        function switchTab(tabName) {
            // For future expansion with multiple tabs
            console.log('Switched to tab:', tabName);
        }

        function refreshData() {
            // Force bypass cache for current filters
            applyFilters({ force: true });
        }

        function goToGamePage(gameId) {
            window.location.href = `/game/${gameId}?id=${gameId}`;
        }

        async function viewGameDetails(gameId, type) {
            let endpoint, title;
            
            if (type === 'summary') {
                endpoint = 'summary';
                title = 'Game Lineups';
            } else if (type === 'test') {
                endpoint = 'summary/test';
                title = 'Test Lineups (Sample Data)';
            } else {
                endpoint = 'playbyplay';
                title = 'Play-by-Play';
            }
            
            try {
                document.getElementById('modalTitle').innerText = `${title} - Game ${gameId}`;
                document.getElementById('modalBody').innerHTML = '<div style="text-align: center; padding: 2rem;">Loading...</div>';
                document.getElementById('gameModal').style.display = 'block';
                
                const response = await fetch(`/api/game/${endpoint}/${gameId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const modalBody = document.getElementById('modalBody');
                    
                    if (type === 'summary' || type === 'test') {
                        modalBody.innerHTML = formatGameSummary(data);
                    } else {
                        modalBody.innerHTML = formatPlayByPlay(data);
                    }
                } else {
                    document.getElementById('modalBody').innerHTML = 
                        `<div style="color: #f56565; text-align: center; padding: 2rem;">
                            Error loading ${title.toLowerCase()}: ${data.error || 'Unknown error'}
                        </div>`;
                }
                
            } catch (error) {
                console.error(`Error fetching ${type} for game ${gameId}:`, error);
                document.getElementById('modalBody').innerHTML = 
                    `<div style="color: #f56565; text-align: center; padding: 2rem;">
                        Error loading ${title.toLowerCase()}. Please try again.
                    </div>`;
            }
        }

        function formatGameSummary(data) {
            let html = '<div class="game-summary">';
            
            // Home Team Lineup
            if (data.homeTeam) {
                html += `<div class="section"><h3>ÔøΩ ${data.homeTeam.name || 'Home Team'}</h3>`;
                
                // Goalies
                if (data.homeTeam.goalies && Array.isArray(data.homeTeam.goalies)) {
                    html += '<h4>ü•Ö Goalies</h4><div class="roster-grid">';
                    data.homeTeam.goalies.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'G'}</small><br>
                            ${stats.gamesPlayed ? `<small>GP: ${stats.gamesPlayed} | W: ${stats.wins || 0} | L: ${stats.losses || 0}</small><br>` : ''}
                            ${stats.savePct ? `<small>Save %: ${(stats.savePct * 100).toFixed(1)}%</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Skaters
                if (data.homeTeam.skaters && Array.isArray(data.homeTeam.skaters)) {
                    html += '<h4>üèí Skaters</h4><div class="roster-grid">';
                    data.homeTeam.skaters.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'Skater'}</small><br>
                            ${stats.goals !== undefined ? `<small>G: ${stats.goals} | A: ${stats.assists || 0} | P: ${stats.points || 0}</small><br>` : ''}
                            ${stats.plusMinus !== undefined ? `<small>+/-: ${stats.plusMinus > 0 ? '+' + stats.plusMinus : stats.plusMinus}</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            // Visiting Team Lineup
            if (data.visitingTeam) {
                html += `<div class="section"><h3>‚úàÔ∏è ${data.visitingTeam.name || 'Visiting Team'}</h3>`;
                
                // Goalies
                if (data.visitingTeam.goalies && Array.isArray(data.visitingTeam.goalies)) {
                    html += '<h4>ü•Ö Goalies</h4><div class="roster-grid">';
                    data.visitingTeam.goalies.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'G'}</small><br>
                            ${stats.gamesPlayed ? `<small>GP: ${stats.gamesPlayed} | W: ${stats.wins || 0} | L: ${stats.losses || 0}</small><br>` : ''}
                            ${stats.savePct ? `<small>Save %: ${(stats.savePct * 100).toFixed(1)}%</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Skaters
                if (data.visitingTeam.skaters && Array.isArray(data.visitingTeam.skaters)) {
                    html += '<h4>üèí Skaters</h4><div class="roster-grid">';
                    data.visitingTeam.skaters.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'Skater'}</small><br>
                            ${stats.goals !== undefined ? `<small>G: ${stats.goals} | A: ${stats.assists || 0} | P: ${stats.points || 0}</small><br>` : ''}
                            ${stats.plusMinus !== undefined ? `<small>+/-: ${stats.plusMinus > 0 ? '+' + stats.plusMinus : stats.plusMinus}</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            // Handle the case where API returns "Client access denied" or other errors
            if (!data.homeTeam && !data.visitingTeam) {
                if (typeof data === 'string' && data.includes('denied')) {
                    html += `<div class="section" style="text-align: center; padding: 2rem;">
                        <h3>üîí Lineup Data Currently Unavailable</h3>
                        <p style="color: #a0aec0; margin: 1rem 0;">
                            The PWHL lineup data is currently restricted by the API provider.
                        </p>
                        <p style="color: #a0aec0; margin: 1rem 0;">
                            We're working on alternative methods to provide team lineups including:
                        </p>
                        <ul style="text-align: left; max-width: 400px; margin: 1rem auto; color: #e2e8f0;">
                            <li>ü•Ö Goalie assignments</li>
                            <li>üèí Starting skater lineups</li>
                            <li>üìã Full roster information</li>
                            <li>üìä Player statistics</li>
                        </ul>
                        <p style="color: #4299e1; margin-top: 1.5rem;">
                            <strong>Play-by-Play data is still available!</strong>
                        </p>
                    </div>`;
                } else {
                    // Show raw data for debugging other cases
                    html += '<div class="section">';
                    html += '<h3>ÔøΩ Game Data</h3>';
                    html += `<p style="color: #a0aec0; margin-bottom: 1rem;">Raw API response:</p>`;
                    html += `<pre style="white-space: pre-wrap; font-size: 11px; overflow-x: auto; background-color: #1e2329; padding: 1rem; border-radius: 0.25rem; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>`;
                    html += '</div>';
                }
            }
            
            html += '</div>';
            return html;
        }

        function formatPlayByPlay(data) {
            if (!Array.isArray(data) || data.length === 0) {
                return '<div style="text-align: center; padding: 2rem; color: #a0aec0;">No play-by-play data available.</div>';
            }
            
            let html = '<div class="play-by-play"><h3>‚ö° Game Events</h3>';
            html += '<div class="events-list">';
            
            data.slice(0, 100).forEach((event, index) => { // Limit to first 100 events for performance
                const details = event.details || {};
                const eventType = event.event || 'unknown';
                const time = details.time || 'N/A';
                const period = details.period || 'N/A';
                
                let eventDescription = '';
                let eventIcon = '';
                
                switch (eventType) {
                    case 'goal':
                        eventIcon = '‚öΩ';
                        eventDescription = `GOAL - ${details.scoredBy || 'Unknown'} (${details.scorerGoalNumber || '1'})`;
                        break;
                    case 'shot':
                        eventIcon = details.isGoal ? '‚öΩ' : 'üèí';
                        eventDescription = `${details.isGoal ? 'GOAL' : 'SHOT'} - ${details.shotQuality || 'Shot'}`;
                        break;
                    case 'penalty':
                        eventIcon = '‚ö†Ô∏è';
                        eventDescription = `PENALTY - ${details.description || 'Penalty'} (${details.minutes || '2'} min)`;
                        break;
                    case 'faceoff':
                        eventIcon = 'üîÑ';
                        eventDescription = `Faceoff - ${details.homeWin ? 'Home' : 'Away'} wins`;
                        break;
                    case 'hit':
                        eventIcon = 'üí•';
                        eventDescription = 'Hit';
                        break;
                    case 'blocked_shot':
                        eventIcon = 'üõ°Ô∏è';
                        eventDescription = 'Blocked Shot';
                        break;
                    case 'goalie_change':
                        eventIcon = 'ü•Ö';
                        eventDescription = 'Goalie Change';
                        break;
                    default:
                        eventIcon = 'üìù';
                        eventDescription = eventType.replace('_', ' ').toUpperCase();
                }
                
                html += `<div class="event-item ${eventType}">
                    <div class="event-time">
                        <strong>P${period}</strong><br>
                        <span>${time}</span>
                    </div>
                    <div class="event-description">
                        ${eventIcon} ${eventDescription}
                    </div>
                </div>`;
            });
            
            if (data.length > 100) {
                html += `<div class="event-item" style="text-align: center; color: #a0aec0;">
                    <div class="event-description">... and ${data.length - 100} more events</div>
                </div>`;
            }
            
            html += '</div></div>';
            return html;
        }

        function closeModal() {
            document.getElementById('gameModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('gameModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        async function exportCSV() {
            const seasonYear = document.getElementById('seasonFilter').value;
            const seasonState = document.getElementById('seasonStateFilter').value;

            // Build CSV string with UTF-8 BOM so Excel respects encoding (handles accents like Montr√©al)
            const header = "Date,Season,State,Away Team,Home Team,Status,Away Score,Home Score,Game ID\n";
            const rows = currentData.map(game => 
                `"${game.date}","${game.season_year}","${game.season_state}","${game.away_team}","${game.home_team}","${game.status}","${game.away_score}","${game.home_score}","${game.game_id}"`
            ).join('\n');
            const csvString = '\ufeff' + header + rows; // Keep BOM for schedule export (helps Excel)
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8' });

            // Suggested filename
            let filename = 'pwhl_schedule';
            if (seasonYear !== 'All') filename += `_${seasonYear.replace('/', '_')}`;
            if (seasonState !== 'All') filename += `_${seasonState.replace(' ', '_').toLowerCase()}`;
            filename += '.csv';

            // Use File System Access API when available (Chrome/Edge) for a real Save As dialog
            try {
                if ('showSaveFilePicker' in window) {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{ description: 'CSV Files', accept: { 'text/csv': ['.csv'] } }]
                    });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    return;
                }
            } catch (err) {
                console.warn('Save File Picker failed, falling back to standard download:', err);
            }

            // Fallback for browsers without File System Access API
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename; // Triggers Save As in most browsers or uses default Downloads
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>