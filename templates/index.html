<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWHL Analytics</title>
    <!-- Favicons: prefer small PNG; fallback to ICO -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png?v=2">
    <link rel="icon" href="/favicon.ico?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='PWHL_logo.png', v='2') }}">
    <style>
        /* Core layout + schedule styling */
        :root { --pwhl-bg:#160A3A; --pwhl-surface:#1e2329; --pwhl-border:#4a5568; --pwhl-accent:#8E7CD6; --pwhl-accent-strong:#B9A7FF; }
        body { margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Helvetica, Arial, sans-serif; background:linear-gradient(135deg,#160A3A 0%,#251055 48%,#3B1E7A 100%); color:#e2e8f0; }
        .header { display:flex; justify-content:space-between; align-items:center; padding:0.75rem 1rem; background:rgba(0,0,0,.25); backdrop-filter:blur(6px); border-bottom:1px solid rgba(255,255,255,.07); }
        .header h1 { display:flex; gap:.5rem; align-items:center; font-size:1.05rem; margin:0; letter-spacing:.5px; }
        .header-actions button { margin-left:.5rem; }
        .btn { background:var(--pwhl-accent); color:#fff; border:none; padding:.55rem .9rem; border-radius:6px; font-weight:600; cursor:pointer; font-size:.75rem; letter-spacing:.5px; }
        .btn:hover { background:var(--pwhl-accent-strong); }
        .btn.btn-secondary { background:#2d3748; }
        .btn.btn-secondary:hover { background:#374151; }
        .container { display:flex; min-height:calc(100vh - 56px); }
        .sidebar { width:240px; padding:1rem; background:rgba(0,0,0,.25); backdrop-filter:blur(6px); border-right:1px solid rgba(255,255,255,.08); }
        .main-content { flex:1; display:flex; flex-direction:column; }
        .tabs { display:flex; gap:.25rem; padding:.5rem 1rem .25rem; border-bottom:1px solid rgba(255,255,255,.08); }
        .tab { background:transparent; border:none; color:#cbd5e0; padding:.6rem 1rem; font-weight:600; cursor:pointer; font-size:.8rem; letter-spacing:.5px; border-bottom:2px solid transparent; }
        .tab.active { color:var(--pwhl-accent-strong); border-bottom-color:var(--pwhl-accent-strong); }
        .tab-content { flex:1; padding:1rem 1.25rem 2rem; overflow:auto; }
        .filter-label { display:block; margin-bottom:.35rem; font-size:.65rem; text-transform:uppercase; letter-spacing:.5px; font-weight:600; opacity:.85; }
        .filter-select { width:100%; background:#2d3748; border:1px solid #4a5568; color:#fff; border-radius:4px; padding:.5rem .55rem; font-size:.75rem; }
        .filter-select:focus { outline:none; border-color:var(--pwhl-accent); box-shadow:0 0 0 3px rgba(142,124,214,.25); }
        input[type=date].filter-select { color-scheme:dark; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:.75rem; margin-bottom:1rem; }
        .stat-card { background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:6px; padding:.75rem .85rem; }
        .stat-value { font-size:1.4rem; font-weight:600; color:var(--pwhl-accent-strong); margin:0 0 .15rem; }
        .stat-label { font-size:.65rem; text-transform:uppercase; letter-spacing:.5px; opacity:.7; }
        .table-container { background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:6px; overflow:hidden; }
        table { width:100%; border-collapse:collapse; font-size:.72rem; }
        th, td { padding:.55rem .6rem; text-align:center; border-bottom:1px solid rgba(255,255,255,.06); }
        th { background:rgba(255,255,255,.05); text-transform:uppercase; font-size:.6rem; letter-spacing:.6px; font-weight:600; }
        tr:hover { background:rgba(142,124,214,.12); }
        td.score { font-weight:600; }
        .status-badge { padding:.2rem .45rem; border-radius:12px; font-size:.55rem; text-transform:uppercase; font-weight:700; letter-spacing:.5px; }
        .status-final { background:#48bb78; color:#102415; }
        .status-pending { background:#ed8936; color:#2d1d06; }
        .no-data { padding:1.25rem; text-align:center; font-size:.75rem; opacity:.75; }
        @media (max-width:880px){ .container { flex-direction:column; } .sidebar { width:100%; display:flex; flex-wrap:wrap; gap:1rem; max-height:none; } .filter-group { width:calc(50% - .5rem); } }
    </style>

        .tab.active {
            background: transparent;
            color: var(--pwhl-accent-strong);
            border-bottom-color: var(--pwhl-accent-strong);
        }

        .tab-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .filter-select {
            width: 100%;
            background-color: #4a5568;
            border: 1px solid #718096;
            border-radius: 0.375rem;
            padding: 0.5rem;
            color: #ffffff;
            font-size: 0.875rem;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        /* Date input styling */
        input[type="date"].filter-select {
            color-scheme: dark;
        }

        input[type="date"].filter-select::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4299e1;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: #a0aec0;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .table-container {
            background: var(--pwhl-surface);
            border: 1px solid var(--pwhl-border);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #4a5568;
        }

        .table th:first-child,
        .table td:first-child {
            text-align: left;
        }

        .table th {
            background: rgba(26, 32, 44, 0.5);
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            color: #e2e8f0;
            font-size: 0.875rem;
        }

        .table tbody tr:hover {
            background-color: rgba(142, 124, 214, 0.12);
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-final {
            background-color: #48bb78;
            color: #1a202c;
        }

        .status-pending {
            background-color: #ed8936;
            color: #1a202c;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #a0aec0;
        }

        .no-data {
            text-align: center;
            color: #a0aec0;
            padding: 2rem;
        }

        .score {
            font-weight: 600;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: #2d3748;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background-color: #1e2329;
            padding: 1rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #4299e1;
        }

        .close {
            color: #a0aec0;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #ffffff;
        }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .game-summary {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .section {
            background-color: #1e2329;
            border: 1px solid #4a5568;
            border-radius: 0.375rem;
            padding: 1rem;
        }

        .section h3 {
            margin: 0 0 1rem 0;
            color: #4299e1;
            border-bottom: 1px solid #4a5568;
            padding-bottom: 0.5rem;
        }

        .section h4 {
            margin: 1rem 0 0.5rem 0;
            color: #e2e8f0;
        }

        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .player-card {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.25rem;
            padding: 0.5rem;
        }

        .play-by-play {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .events-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            border-radius: 0.375rem;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid #4a5568;
            background-color: #1e2329;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-item.goal {
            background-color: rgba(72, 187, 120, 0.1);
            border-left: 4px solid #48bb78;
        }

        .event-item.penalty {
            background-color: rgba(245, 101, 101, 0.1);
            border-left: 4px solid #f56565;
        }

        .event-time {
            min-width: 80px;
            text-align: center;
            font-family: 'Courier New', monospace;
            color: #a0aec0;
        }

        .event-description {
            flex: 1;
            color: #e2e8f0;
        }

        /* Clickable row styles */
        .game-row.clickable:hover {
            background-color: #2d3748;
            transition: background-color 0.2s;
        }

        .game-row.clickable:hover td {
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <img src="{{ url_for('static', filename='PWHL_logo.png') }}" alt="PWHL" style="height:28px; width:auto; vertical-align:middle; display:inline-block;">
            <span>PWHL Analytics</span>
        </h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            <button class="btn" onclick="refreshData()">Refresh</button>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="filter-group">
                <label class="filter-label">Season</label>
                <select class="filter-select" id="seasonFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Seasons</option>
                    <option value="2025/2026" selected>2025/2026</option>
                    <option value="2024/2025">2024/2025</option>
                    <option value="2023/2024">2023/2024</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Season State</label>
                <select class="filter-select" id="seasonStateFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Season States</option>
                    <option value="Regular Season" selected>Regular Season</option>
                    <option value="Playoffs">Playoffs</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Date From</label>
                <input type="date" class="filter-select" id="dateFromFilter" onchange="applyFilters({preferCache: true})">
            </div>

            <div class="filter-group">
                <label class="filter-label">Date To</label>
                <input type="date" class="filter-select" id="dateToFilter" onchange="applyFilters({preferCache: true})">
            </div>

            <div class="filter-group">
                <label class="filter-label">Team</label>
                <select class="filter-select" id="teamFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Teams</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="filter-select" id="statusFilter" onchange="applyFilters({preferCache: true})">
                    <option value="All">All Statuses</option>
                </select>
            </div>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" id="tabSchedule" onclick="switchTab('schedule')">üìÖ Schedule</button>
                <a class="tab" id="tabReportLink" href="/Report" style="text-decoration:none; display:inline-block; padding:0.75rem 1rem;">üìä Report</a>
            </div>

            <div class="tab-content">
                <!-- Schedule stats -->
                <div class="stats-grid" id="scheduleStats">
                    <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Games</div></div>
                    <div class="stat-card"><div class="stat-value" id="statCompleted">0</div><div class="stat-label">Completed</div></div>
                    <div class="stat-card"><div class="stat-value" id="statPending">0</div><div class="stat-label">Pending</div></div>
                </div>

        async function loadSchedule() {
            // This function is now handled by applyFilters()
            applyFilters();
        }

        function updateFilterOptions() {
            // Update team filter
            const teamSelect = document.getElementById('teamFilter');
            const currentTeam = teamSelect.value;
            teamSelect.innerHTML = '<option value="All">All Teams</option>';
            allFilters.teams.forEach(team => {
                if (team) {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    if (team === currentTeam) option.selected = true;
                    teamSelect.appendChild(option);
                }
            });

            // Update status filter
            const statusSelect = document.getElementById('statusFilter');
            const currentStatus = statusSelect.value;
            statusSelect.innerHTML = '<option value="All">All Statuses</option>';
            allFilters.statuses.forEach(status => {
                if (status) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    statusSelect.appendChild(option);
                }
            });
        }

        async function applyFilters(options = {}) {
            const { preferCache = false, force = false } = options;
            const seasonYear = document.getElementById('seasonFilter').value;
            const seasonState = document.getElementById('seasonStateFilter').value;
            const team = document.getElementById('teamFilter').value;
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            // Persist current filters
            saveFilterState({ seasonYear, seasonState, team, status, dateFrom, dateTo });

            // Build request URL (also used as cache key)
            let url = `/api/schedule?season_year=${encodeURIComponent(seasonYear)}&season_state=${encodeURIComponent(seasonState)}&team=${encodeURIComponent(team)}&status=${encodeURIComponent(status)}`;
            if (dateFrom) url += `&date_from=${encodeURIComponent(dateFrom)}`;
            if (dateTo) url += `&date_to=${encodeURIComponent(dateTo)}`;

            const now = Date.now();

            // Cache-first path
            const cached = scheduleCache[url];
            const fresh = cached && (now - cached.fetchedAt) < CACHE_TTL_MS;

            if (!force && preferCache && cached) {
                // Render immediately from cache
                const data = cached.data;
                currentData = data.games;
                allFilters = data.filters;
                updateFilterOptions();
                updateStats(data.stats);
                renderTable(data.games);

                // If cache is fresh, skip network; else revalidate in background
                if (fresh) return;

                // Background revalidation
                try {
                    const resp = await fetch(url, { cache: 'no-store' });
                    const newData = await resp.json();
                    scheduleCache[url] = { data: newData, fetchedAt: Date.now() };
                    currentData = newData.games;
                    allFilters = newData.filters;
                    updateFilterOptions();
                    updateStats(newData.stats);
                    renderTable(newData.games);
                } catch (e) {
                    console.warn('Revalidation failed, using cached data:', e);
                }
                return;
            }

            // If we get here and either no cache or not preferring cache, show loading
            document.getElementById('scheduleTableBody').innerHTML = 
                '<tr><td colspan="8" class="loading">Loading schedule data...</td></tr>';

            try {
                const response = await fetch(url, { cache: force ? 'reload' : 'default' });
                const data = await response.json();
                scheduleCache[url] = { data, fetchedAt: Date.now() };

                currentData = data.games;
                allFilters = data.filters;
                updateFilterOptions();
                updateStats(data.stats);
                renderTable(data.games);
            } catch (error) {
                console.error('Error applying filters:', error);
                document.getElementById('scheduleTableBody').innerHTML = 
                    '<tr><td colspan="8" class="no-data">Error loading schedule data</td></tr>';
            }
        }

        /* Schedule only page; removed embedded report code */

        function refreshData(){ applyFilters({force:true}); }

        function goToGamePage(gameId) {
            window.location.href = `/game/${gameId}?id=${gameId}`;
        }

        async function viewGameDetails(gameId, type) {
            let endpoint, title;
            
            if (type === 'summary') {
                endpoint = 'summary';
                title = 'Game Lineups';
            } else if (type === 'test') {
                endpoint = 'summary/test';
                title = 'Test Lineups (Sample Data)';
            } else {
                endpoint = 'playbyplay';
                title = 'Play-by-Play';
            }
            
            try {
                document.getElementById('modalTitle').innerText = `${title} - Game ${gameId}`;
                document.getElementById('modalBody').innerHTML = '<div style="text-align: center; padding: 2rem;">Loading...</div>';
                document.getElementById('gameModal').style.display = 'block';
                
                const response = await fetch(`/api/game/${endpoint}/${gameId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const modalBody = document.getElementById('modalBody');
                    
                    if (type === 'summary' || type === 'test') {
                        modalBody.innerHTML = formatGameSummary(data);
                    } else {
                        modalBody.innerHTML = formatPlayByPlay(data);
                    }
                } else {
                    document.getElementById('modalBody').innerHTML = 
                        `<div style="color: #f56565; text-align: center; padding: 2rem;">
                            Error loading ${title.toLowerCase()}: ${data.error || 'Unknown error'}
                        </div>`;
                }
                
            } catch (error) {
                console.error(`Error fetching ${type} for game ${gameId}:`, error);
                document.getElementById('modalBody').innerHTML = 
                    `<div style="color: #f56565; text-align: center; padding: 2rem;">
                        Error loading ${title.toLowerCase()}. Please try again.
                    </div>`;
            }
        }

    function formatGameSummary(data) {
            let html = '<div class="game-summary">';
            
            // Home Team Lineup
            if (data.homeTeam) {
                html += `<div class="section"><h3>ÔøΩ ${data.homeTeam.name || 'Home Team'}</h3>`;
                
                // Goalies
                if (data.homeTeam.goalies && Array.isArray(data.homeTeam.goalies)) {
                    html += '<h4>ü•Ö Goalies</h4><div class="roster-grid">';
                    data.homeTeam.goalies.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'G'}</small><br>
                            ${stats.gamesPlayed ? `<small>GP: ${stats.gamesPlayed} | W: ${stats.wins || 0} | L: ${stats.losses || 0}</small><br>` : ''}
                            ${stats.savePct ? `<small>Save %: ${(stats.savePct * 100).toFixed(1)}%</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Skaters
                if (data.homeTeam.skaters && Array.isArray(data.homeTeam.skaters)) {
                    html += '<h4>üèí Skaters</h4><div class="roster-grid">';
                    data.homeTeam.skaters.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'Skater'}</small><br>
                            ${stats.goals !== undefined ? `<small>G: ${stats.goals} | A: ${stats.assists || 0} | P: ${stats.points || 0}</small><br>` : ''}
                            ${stats.plusMinus !== undefined ? `<small>+/-: ${stats.plusMinus > 0 ? '+' + stats.plusMinus : stats.plusMinus}</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            // Visiting Team Lineup
            if (data.visitingTeam) {
                html += `<div class="section"><h3>‚úàÔ∏è ${data.visitingTeam.name || 'Visiting Team'}</h3>`;
                
                // Goalies
                if (data.visitingTeam.goalies && Array.isArray(data.visitingTeam.goalies)) {
                    html += '<h4>ü•Ö Goalies</h4><div class="roster-grid">';
                    data.visitingTeam.goalies.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'G'}</small><br>
                            ${stats.gamesPlayed ? `<small>GP: ${stats.gamesPlayed} | W: ${stats.wins || 0} | L: ${stats.losses || 0}</small><br>` : ''}
                            ${stats.savePct ? `<small>Save %: ${(stats.savePct * 100).toFixed(1)}%</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Skaters
                if (data.visitingTeam.skaters && Array.isArray(data.visitingTeam.skaters)) {
                    html += '<h4>üèí Skaters</h4><div class="roster-grid">';
                    data.visitingTeam.skaters.forEach(player => {
                        const stats = player.stats || {};
                        html += `<div class="player-card">
                            <strong>#${player.jersey || 'N/A'} ${player.name || 'Unknown'}</strong><br>
                            <small>${player.position || 'Skater'}</small><br>
                            ${stats.goals !== undefined ? `<small>G: ${stats.goals} | A: ${stats.assists || 0} | P: ${stats.points || 0}</small><br>` : ''}
                            ${stats.plusMinus !== undefined ? `<small>+/-: ${stats.plusMinus > 0 ? '+' + stats.plusMinus : stats.plusMinus}</small>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            // Handle the case where API returns "Client access denied" or other errors
            if (!data.homeTeam && !data.visitingTeam) {
                if (typeof data === 'string' && data.includes('denied')) {
                    html += `<div class="section" style="text-align: center; padding: 2rem;">
                        <h3>üîí Lineup Data Currently Unavailable</h3>
                        <p style="color: #a0aec0; margin: 1rem 0;">
                            The PWHL lineup data is currently restricted by the API provider.
                        </p>
                        <p style="color: #a0aec0; margin: 1rem 0;">
                            We're working on alternative methods to provide team lineups including:
                        </p>
                        <ul style="text-align: left; max-width: 400px; margin: 1rem auto; color: #e2e8f0;">
                            <li>ü•Ö Goalie assignments</li>
                            <li>üèí Starting skater lineups</li>
                            <li>üìã Full roster information</li>
                            <li>üìä Player statistics</li>
                        </ul>
                        <p style="color: #4299e1; margin-top: 1.5rem;">
                            <strong>Play-by-Play data is still available!</strong>
                        </p>
                    </div>`;
                } else {
                    // Show raw data for debugging other cases
                    html += '<div class="section">';
                    html += '<h3>ÔøΩ Game Data</h3>';
                    html += `<p style="color: #a0aec0; margin-bottom: 1rem;">Raw API response:</p>`;
                    html += `<pre style="white-space: pre-wrap; font-size: 11px; overflow-x: auto; background-color: #1e2329; padding: 1rem; border-radius: 0.25rem; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>`;
                    html += '</div>';
                }
            }
            
            html += '</div>';
            return html;
        }

    function formatPlayByPlay(data) {
            if (!Array.isArray(data) || data.length === 0) {
                return '<div style="text-align: center; padding: 2rem; color: #a0aec0;">No play-by-play data available.</div>';
            }
            
            let html = '<div class="play-by-play"><h3>‚ö° Game Events</h3>';
            html += '<div class="events-list">';
            
            data.slice(0, 100).forEach((event, index) => { // Limit to first 100 events for performance
                const details = event.details || {};
                const eventType = event.event || 'unknown';
                const time = details.time || 'N/A';
                const period = details.period || 'N/A';
                
                let eventDescription = '';
                let eventIcon = '';
                
                switch (eventType) {
                    case 'goal':
                        eventIcon = '‚öΩ';
                        eventDescription = `GOAL - ${details.scoredBy || 'Unknown'} (${details.scorerGoalNumber || '1'})`;
                        break;
                    case 'shot':
                        eventIcon = details.isGoal ? '‚öΩ' : 'üèí';
                        eventDescription = `${details.isGoal ? 'GOAL' : 'SHOT'} - ${details.shotQuality || 'Shot'}`;
                        break;
                    case 'penalty':
                        eventIcon = '‚ö†Ô∏è';
                        eventDescription = `PENALTY - ${details.description || 'Penalty'} (${details.minutes || '2'} min)`;
                        break;
                    case 'faceoff':
                        eventIcon = 'üîÑ';
                        eventDescription = `Faceoff - ${details.homeWin ? 'Home' : 'Away'} wins`;
                        break;
                    case 'hit':
                        eventIcon = 'üí•';
                        eventDescription = 'Hit';
                        break;
                    case 'blocked_shot':
                        eventIcon = 'üõ°Ô∏è';
                        eventDescription = 'Blocked Shot';
                        break;
                    case 'goalie_change':
                        eventIcon = 'ü•Ö';
                        eventDescription = 'Goalie Change';
                        break;
                    default:
                        eventIcon = 'üìù';
                        eventDescription = eventType.replace('_', ' ').toUpperCase();
                }
                
                html += `<div class="event-item ${eventType}">
                    <div class="event-time">
                        <strong>P${period}</strong><br>
                        <span>${time}</span>
                    </div>
                    <div class="event-description">
                        ${eventIcon} ${eventDescription}
                    </div>
                </div>`;
            });
            
            if (data.length > 100) {
                html += `<div class="event-item" style="text-align: center; color: #a0aec0;">
                    <div class="event-description">... and ${data.length - 100} more events</div>
                </div>`;
            }
            
            html += '</div></div>';
            return html;
        }

        function closeModal() {
            document.getElementById('gameModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('gameModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        async function exportCSV() {
            const seasonYear = document.getElementById('seasonFilter').value;
            const seasonState = document.getElementById('seasonStateFilter').value;

            // Build CSV string with UTF-8 BOM so Excel respects encoding (handles accents like Montr√©al)
            const header = "Date,Season,State,Away Team,Home Team,Status,Away Score,Home Score,Game ID\n";
            const rows = currentData.map(game => 
                `"${game.date}","${game.season_year}","${game.season_state}","${game.away_team}","${game.home_team}","${game.status}","${game.away_score}","${game.home_score}","${game.game_id}"`
            ).join('\n');
            const csvString = '\ufeff' + header + rows; // Keep BOM for schedule export (helps Excel)
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8' });

            // Suggested filename
            let filename = 'pwhl_schedule';
            if (seasonYear !== 'All') filename += `_${seasonYear.replace('/', '_')}`;
            if (seasonState !== 'All') filename += `_${seasonState.replace(' ', '_').toLowerCase()}`;
            filename += '.csv';

            // Use File System Access API when available (Chrome/Edge) for a real Save As dialog
            try {
                if ('showSaveFilePicker' in window) {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{ description: 'CSV Files', accept: { 'text/csv': ['.csv'] } }]
                    });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    return;
                }
            } catch (err) {
                console.warn('Save File Picker failed, falling back to standard download:', err);
            }

            // Fallback for browsers without File System Access API
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename; // Triggers Save As in most browsers or uses default Downloads
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>